---
title: CSS 3D Panorama及一些项目开发总结
date: 2017-11-07
---

#### CSS3d
项目涉及的技术主要是CSS3d，3D全景是其应用场景之一
- 优势：因为是基于div+css3实现,相对canvas webgl拥有更好的平台兼容性。
- 劣势：渲染性能相比canvas webgl要弱,只适合创建较小的三维面片场景。

渲染性能这点在项目完成后得到了证实🤣，由于使用了大量CSS3 Transform相关的属性(一个页面内上百个元素)，包括 平移（translate）、旋转（rotate）、缩放（scale），导致在性能较差的移动设备上出现了卡顿和发热的情况。

##### transform相关属性介绍：
- transform：修改 CSS 可视化模型的坐标空间，包括 平移（translate）、旋转（rotate）、缩放（scale） 和 扭曲（skew）
- perspective: 指定了观察者与 z=0 平面的距离，使具有三维变换的元素产生透视效果
- transform-style：为子元素提供 2D 还是 3D 的场景。另外，该属性是非继承的
- transform-origin：允许被转换元素位置

##### 实现CSS3D全景
什么是全景？

当你站在一个点，身体旋转360°，这个过程看到的画面就是以你为中心的全景图了，焦距不变时等同于站在一个圆柱体的中心。

![img](https://misc.aotu.io/JChehe/2016-8-24-css-3d-panorama/panorama3d.jpg)

那么当我们有了全景图的素材后，将其切割为若干份，通过 transform 的平移和旋转将其拼为一个多棱柱，并通过 perspective 将视角置于棱柱中心(计算机世界是离散的，不能实现完美的圆柱，只能用近似圆柱的棱柱来代替)，就实现了全景效果。

未来城活动页是将全景图分割成60等份，相邻的元素构成夹角6°(360/60,相邻两侧面相对于棱柱中心所构成的夹角)。需要注意的是：我们要确保每个元素的正面是指向棱柱中心的。所以要计算好每等份的旋转角度值后，再将元素向外（即 Z 轴方向）平移 r px。对于立方体的 r 就是 边长/2。

举个栗子：对于正九棱柱，每个元素的宽为 210px，对应的角度为 40°，即如下图

![img](https://misc.aotu.io/JChehe/2016-8-24-css-3d-panorama/diagram.png)

正九棱柱的俯视图

![img](https://misc.aotu.io/JChehe/2016-8-24-css-3d-panorama/calc.png)

计算过程

由此可得到一个公用函数，只需传入含有元素的宽度和元素数量的对象，即可得到 r 值：

```js
function calTranslateZ(opts) {
  return Math.round(opts.width / (2 * Math.tan(Math.PI / opts.number)))
}
calTranlateZ({
    width: 210,
    number: 9
});  // 288

```

##### 设置视角
正棱柱构建完成后，需要将我们的视角设置在正棱柱内，超过视角外的元素不会被浏览器渲染(translateZ > perspective)，并且保证棱柱的正面都是指向正棱柱中心，就可以形成360°的环绕效果了。

```css
#view(perspective:1000px)
    #stage(transform-style:preserve-3d)
        #cube(transform-style:preserve-3d)
            .div（width:600px;height:600px;） /*组成棱柱的元素*/
```
只要保证.div元素自身 Z 坐标和祖先元素 Z 坐标相加大于 #view 元素的 perspective 值即可。

##### 对于全景图素材的要求
1. 水平方向上需要首尾相连
2. 因为效果图最终需要切成 N 等份，所以尽可能让 设计图的宽度能被 N 整除
3. 图片尺寸不仅要考虑正视图的大小，还要考虑元素在上下旋转时依然能覆盖视野

##### 参考资料
- [前端的3D(css3版本)--淘宝造物节3D创景的制作](https://segmentfault.com/a/1190000009821454)
- [CSS 3D Panorama - 淘宝造物节技术剖析](https://aotu.io/notes/2016/08/24/2016-8-24-css-3d-panorama/)
- 另外项目中使用了一个小巧实用的辅助支持库,对相关元素及方法进行了封装：[css3d-engine](https://github.com/shrekshrek/css3d-engine)

#### 一些总结
##### 项目开发流程
当拿到项目需求后进行需求评审然后一般按照以下流程进行开发

![img](http://haitao.nos.netease.com/1d0ecf9c43884fa6ac6355e8da873891.png)

##### 分析较复杂逻辑时使用脑图
由于项目当中涉及登录之后的逻辑较为复杂，使用脑图后将流程以及逻辑罗列便于理清

![img](https://haitao.nos.netease.com/e2b7629d-e27a-4ab5-83c5-075836ff2520.png)

##### 工作量评估
对于有经验的开发者来说，对于自己的开发量以及开发速度有一个较为准确的把控，因此能够制定合理的排期计划

- 按照需求和交互稿划分功能模块，根据每个模块的复杂度来确定开发时间，最后加起来，并且需留出一定的时间用于自测以及开发和联调
- 采用前紧后松的开发方式，项目中期遇到需求变更也能够游刃有余
- 对于需求方提出的需求进行合理评估，若工作量或投入与收到的效益不成正比，则应主动反馈，确定另外的解决方案

##### 工作方法
1. 沟通能力

    沟通要领
    - 用沟通代替自作主张
    - 多做反馈，主动反馈
    - 有风险及时抛出

2. 正视资源不足
    > “如果什么都准备好了，那这个事情谁都能做，公司还要花高工资招你干嘛？”

3. 问题到我为止

    当产品让你看一个现网问题
    > “这不是前端问题，你问下后台同学”
    
    > “我和后台某某同学对过，是他们那边xxx引起的问题。我们讨论后，有xxx和xxx两种方案，打算采用xxx方案，解决更彻底，预计xxx完成。虽然不是前端问题，但前端这边也打算做xxx的兼容优化，保证出问题时不影响体验，明天完成......”

4. 培养高效工作方法
    - [找到适合自己的工作方法](http://www.dsb.cn/52907.html)

最后，***乐观自信和技术能力一样重要***
